<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo Cáo Bán Hàng</title>
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #wrapper {
      display: flex;
      height: 100vh;
    }
    #filters {
      width: 18%;
      background: #f8f9fa;
      padding: 1rem;
      overflow-y: auto;
      border-right: 2px solid #3f8384;
    }
    #reportArea {
      width: 82%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #reportTable {
      flex: 1;
      overflow: auto;
    }
    h4, label {
      color: #3f8384;
    }
    .tabulator .tabulator-header .tabulator-col {
      background-color: #3f8384;
      color: white;
      text-align: center;
    }
    .tabulator .tabulator-row .tabulator-cell.numeric {
      text-align: right;
    }
    .filter-group {
      margin-bottom: 12px;
    }
    .filter-group label {
      font-weight: bold;
    }
    .checkbox-group {
      border: 1px solid #ccc;
      padding: 5px;
      max-height: 120px;
      overflow-y: auto;
      background: #fff;
    }
  </style>
</head>
<body>
<div id="wrapper">
  <div id="filters">
    <h4>Bộ Lọc</h4>
    <label>Ngày giao dịch</label>
    <input id="dateRange" class="form-control mb-2" />

    <label>Khách hàng</label>
    <input id="customerFilter" class="form-control mb-2" placeholder="Tên khách hàng" />

    <div class="filter-group">
      <label>Salesman</label>
      <div><button onclick="toggleAll('salesmanFilter', true)">Chọn tất cả</button> <button onclick="toggleAll('salesmanFilter', false)">Bỏ chọn</button></div>
      <div id="salesmanFilter" class="checkbox-group"></div>
    </div>

    <div class="filter-group">
      <label>Sản phẩm</label>
      <div><button onclick="toggleAll('productFilter', true)">Chọn tất cả</button> <button onclick="toggleAll('productFilter', false)">Bỏ chọn</button></div>
      <div id="productFilter" class="checkbox-group"></div>
    </div>

    <div class="filter-group">
      <label>Vùng miền</label>
      <div><button onclick="toggleAll('regionFilter', true)">Chọn tất cả</button> <button onclick="toggleAll('regionFilter', false)">Bỏ chọn</button></div>
      <div id="regionFilter" class="checkbox-group"></div>
    </div>

    <div class="filter-group">
      <label>Quý</label>
      <div><button onclick="toggleAll('quarterFilter', true)">Chọn tất cả</button> <button onclick="toggleAll('quarterFilter', false)">Bỏ chọn</button></div>
      <div id="quarterFilter" class="checkbox-group"></div>
    </div>

    <div class="filter-group">
      <label>Năm</label>
      <div><button onclick="toggleAll('yearFilter', true)">Chọn tất cả</button> <button onclick="toggleAll('yearFilter', false)">Bỏ chọn</button></div>
      <div id="yearFilter" class="checkbox-group"></div>
    </div>

    <button id="applyFilter" class="btn btn-primary mt-3">Lọc dữ liệu</button>
  </div>

  <div id="reportArea">
    <h2 style="text-align:center; color:#3f8384; margin:10px 0;">CHI TIẾT HIỆU QUẢ BÁN HÀNG</h2>
    <div class="d-flex justify-content-end px-3 mb-2">
      <button id="btn-toggle-cols" class="btn btn-outline-primary btn-sm me-2">Ẩn/Hiện Cột</button>
      <button id="btn-export" class="btn btn-success btn-sm">Xuất Excel</button>
    </div>
    <div id="reportTable"></div>
  </div>
</div>

<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rQxWIbh49/exec";

  const picker = new Litepicker({
    element: document.getElementById("dateRange"),
    singleMode: false,
    format: "DD/MM/YYYY"
  });

  function toggleAll(containerId, checked) {
    document.querySelectorAll(`#${containerId} input[type='checkbox']`).forEach(cb => cb.checked = checked);
  }

  const filters = {
    salesmanFilter: "Salesman",
    productFilter: "Sản phẩm",
    regionFilter: "Vùng miền",
    quarterFilter: "Quý",
    yearFilter: "Năm"
  };

  let originalData = [];
  let table;

  function renderCheckboxFilters(data) {
    for (const [containerId, field] of Object.entries(filters)) {
      const container = document.getElementById(containerId);
      const uniqueValues = [...new Set(data.map(row => row[field]).filter(Boolean))].sort();
      container.innerHTML = uniqueValues.map(val => `<div><input type='checkbox' value="${val}" checked> ${val}</div>`).join('');
    }
  }

  function applyFilters() {
    const dateRange = document.getElementById("dateRange").value.split(" - ");
    const customerText = document.getElementById("customerFilter").value.toLowerCase();

    const activeFilters = {};
    for (const [id, field] of Object.entries(filters)) {
      const selected = [...document.querySelectorAll(`#${id} input[type='checkbox']:checked`)].map(cb => cb.value);
      activeFilters[field] = selected;
    }

    const filtered = originalData.filter(row => {
      const matchDate = dateRange.length === 2 ? (() => {
        const [d1, d2] = dateRange.map(d => {
          const [day, month, year] = d.split("/");
          return new Date(`${year}-${month}-${day}`);
        });
        const rowDate = new Date(row["Ngày giao dịch"].split("/").reverse().join("-"));
        return rowDate >= d1 && rowDate <= d2;
      })() : true;

      const matchCustomer = !customerText || row["Khách hàng"].toLowerCase().includes(customerText);

      const matchOthers = Object.entries(activeFilters).every(([field, selected]) => selected.includes(row[field]));

      return matchDate && matchCustomer && matchOthers;
    });

    table.setData(filtered);
  }

  document.getElementById("applyFilter").addEventListener("click", applyFilters);

  function fetchDataJSONP(email, token) {
    const script = document.createElement('script');
    const url = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`;
    script.src = url;
    document.body.appendChild(script);
  }

  function formatNumber(value) {
    return typeof value === "number" ? value.toLocaleString("vi-VN") : value;
  }

  function myCallback(data) {
    if (data.error) {
      document.getElementById("reportTable").innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
      return;
    }

    data.forEach(row => {
      if (row["Ngày giao dịch"] && row["Ngày giao dịch"].includes("T")) {
        const d = new Date(row["Ngày giao dịch"]);
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        row["Ngày giao dịch"] = `${dd}/${mm}/${yyyy}`;
      }
    });

    originalData = data;
    renderCheckboxFilters(data);

    const numericCols = ["Số lượng", "Doanh thu thuần", "Đơn giá", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Giá bán net", "Giá bán tiêu chuẩn", "Lãi gộp tính lương B2B", "LK tiêu chuẩn", "Điều chỉnh lương khoán KD", "Lương khoán tối thiểu", "Lương khoán/kg", "LK Đức HM", "Lương khoán sales"];
    const percentCols = ["% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"];
    const subtotalCols = ["Số lượng", "Doanh thu thuần", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Lãi gộp tính lương B2B", "LK Đức HM", "Lương khoán sales"];

    const columns = Object.keys(data[0]).map(key => {
      const col = {
        title: key,
        field: key,
        cssClass: numericCols.includes(key) ? 'numeric' : '',
        hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left',
        width: key.length * 14 + 50,
      };

      if (percentCols.includes(key)) {
        col.formatter = cell => `${(cell.getValue() * 100).toFixed(2)}%`;
      } else if (numericCols.includes(key)) {
        col.formatter = cell => formatNumber(cell.getValue());
      }

      if (subtotalCols.includes(key)) {
        col.bottomCalc = 'sum';
      }

      if (key === "Giá bán net") {
        col.bottomCalc = (values, data) => {
          const totalRevenue = data.reduce((acc, row) => acc + (parseFloat(row["Doanh thu thuần"]) || 0), 0);
          const totalQty = data.reduce((acc, row) => acc + (parseFloat(row["Số lượng"]) || 0), 0);
          return totalQty !== 0 ? formatNumber(Math.round(totalRevenue / totalQty)) : 0;
        };
      }

      return col;
    });

    table = new Tabulator("#reportTable", {
      data: data,
      columns: columns,
      layout: "fitDataFill",
      responsiveLayout: true,
      movableColumns: true,
      resizableColumns: true,
      height: "100%",
      placeholder: "Không có dữ liệu",
    });

    document.getElementById("btn-export").onclick = () => {
      table.download("xlsx", "bao_cao_ban_hang.xlsx", { sheetName: "Báo cáo" });
    };

    document.getElementById("btn-toggle-cols").onclick = () => {
      table.showColumnSelector();
    };
  }

  window.onload = () => {
    const email = prompt("Nhập email:");
    const token = prompt("Nhập token:");
    fetchDataJSONP(email, token);
  };
</script>
</body>
</html>
