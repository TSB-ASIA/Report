<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B√°o C√°o B√°n H√†ng</title>
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    #wrapper { display: flex; height: 100vh; }
    #filters { width: 18%; padding: 1rem; background: #f8f9fa; overflow-y: auto; border-right: 2px solid #3f8384; }
    #reportArea { width: 82%; display: flex; flex-direction: column; overflow: hidden; }
    #reportTable { flex: 1; overflow-x: auto; }
    h4, label { color: #3f8384; }
    .tabulator .tabulator-header .tabulator-col { background: #3f8384; color: white; text-align: center; }
    .tabulator .tabulator-row .tabulator-cell.numeric { text-align: right; }
    .filter-group { margin-bottom: 12px; }
    .checkbox-group { border: 1px solid #ccc; max-height: 120px; overflow-y: auto; background: #fff; padding: 5px; }
    #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; display: none; }
  </style>
</head>
<body>
<div id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
<div id="wrapper">
  <div id="filters">
    <h4>B·ªô L·ªçc</h4>
    <label>Ng√†y giao d·ªãch</label>
    <input id="dateRange" class="form-control mb-2" />
    <label>Kh√°ch h√†ng</label>
    <input id="customerFilter" class="form-control mb-2" placeholder="T√™n kh√°ch h√†ng" />
    <div class="filter-group"><label>Salesman</label><div id="salesmanFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>S·∫£n ph·∫©m</label><div id="productFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>V√πng mi·ªÅn</label><div id="regionFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Qu√Ω</label><div id="quarterFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>NƒÉm</label><div id="yearFilter" class="checkbox-group"></div></div>
  </div>

  <div id="reportArea">
    <h2 class="text-center text-primary mt-2">CHI TI·∫æT HI·ªÜU QU·∫¢ B√ÅN H√ÄNG</h2>
    <div class="d-flex justify-content-end px-3 mb-2">
      <button id="btn-toggle-cols" class="btn btn-outline-primary btn-sm me-2">·∫®n/Hi·ªán C·ªôt</button>
      <button id="btn-export" class="btn btn-success btn-sm">Xu·∫•t Excel</button>
    </div>
    <div id="reportTable"></div>
  </div>
</div>

<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rQxWIbh49/exec';
let table, originalData = [];
let currentEmail = "", currentToken = "";

const numericCols = ["S·ªë l∆∞·ª£ng", "Doanh thu thu·∫ßn", "ƒê∆°n gi√°", "COGS", "L√£i g·ªôp", "Chi ph√≠ giao h√†ng", "L√£i vay", "Gi√° b√°n net", "Gi√° b√°n ti√™u chu·∫©n", "L√£i g·ªôp t√≠nh l∆∞∆°ng B2B", "LK ti√™u chu·∫©n", "ƒêi·ªÅu ch·ªânh l∆∞∆°ng kho√°n KD", "L∆∞∆°ng kho√°n t·ªëi thi·ªÉu", "L∆∞∆°ng kho√°n/kg", "LK ƒê·ª©c HM", "L∆∞∆°ng kho√°n sales"];
const percentCols = ["% L√£i g·ªôp ti√™u chu·∫©n", "% ƒêi·ªÅu ch·ªânh tr√™n gi√°", "% ƒêi·ªÅu ch·ªânh d∆∞·ªõi gi√°", "% l∆∞∆°ng Kho√°n"];
const subtotalCols = ["S·ªë l∆∞·ª£ng", "Doanh thu thu·∫ßn", "COGS", "L√£i g·ªôp", "Chi ph√≠ giao h√†ng", "L√£i vay", "L√£i g·ªôp t√≠nh l∆∞∆°ng B2B", "LK ƒê·ª©c HM", "L∆∞∆°ng kho√°n sales"];

function showLoading(show = true) {
  document.getElementById("loading").style.display = show ? "flex" : "none";
}

function myCallback(data) {
  showLoading(false);

  // üëâ Check if data is valid array
  if (!Array.isArray(data) || data.length === 0) {
    alert("Sai email ho·∫∑c token. Vui l√≤ng nh·∫≠p l·∫°i.");
    localStorage.removeItem("report_email");
    localStorage.removeItem("report_token");
    location.reload();
    return;
  }

  // ‚úÖ Only save if data is valid
  localStorage.setItem("report_email", currentEmail);
  localStorage.setItem("report_token", currentToken);

  originalData = data.map(row => {
    if (row["Ng√†y giao d·ªãch"]?.includes("T")) {
      const d = new Date(row["Ng√†y giao d·ªãch"]);
      row["Ng√†y giao d·ªãch"] = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    }
    return row;
  });

  buildFilters(originalData);
  const columns = Object.keys(originalData[0]).map(key => ({
    title: key,
    field: key,
    hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left',
    cssClass: numericCols.includes(key) ? 'numeric' : '',
    formatter: numericCols.includes(key) ? cell => Number(cell.getValue()).toLocaleString('en-US') :
               percentCols.includes(key) ? cell => `${Number(cell.getValue()).toFixed(2)}%` : undefined,
    bottomCalc: key === 'Gi√° b√°n net'
      ? (values, data) => {
          const tongDT = data.reduce((s, r) => s + (r['Doanh thu thu·∫ßn'] || 0), 0);
          const tongSL = data.reduce((s, r) => s + (r['S·ªë l∆∞·ª£ng'] || 0), 0);
          return tongSL ? (tongDT / tongSL).toLocaleString('en-US') : 0;
        }
      : subtotalCols.includes(key) ? "sum" : undefined
  }));

  table = new Tabulator("#reportTable", {
    data: originalData,
    columns,
    layout: "fitDataFill",
    height: "100%",
    responsiveLayout: true,
    placeholder: "Kh√¥ng c√≥ d·ªØ li·ªáu",
    rowFormatter: row => {
      if (row.getData()["Salesman"] === "T·ªîNG C·ªòNG") {
        row.getElement().style.backgroundColor = "#e0f0ff";
        row.getElement().style.fontWeight = "bold";
      }
    }
  });

  setupLiveFilterEvents();
}

function fetchDataJSONP(email, token) {
  showLoading(true);
  currentEmail = email;
  currentToken = token;
  const script = document.createElement('script');
  script.src = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`;
  document.body.appendChild(script);
}

function buildFilters(data) {
  ['Salesman', 'S·∫£n ph·∫©m', 'V√πng mi·ªÅn', 'Qu√Ω', 'NƒÉm'].forEach(field => {
    const id = field.toLowerCase().replace(/\s+/g, '') + "Filter";
    const unique = [...new Set(data.map(r => r[field]).filter(Boolean))];
    document.getElementById(id).innerHTML = unique.map(v => `<div><label><input type="checkbox" value="${v}" checked /> ${v}</label></div>`).join('');
  });
}

function getCheckedValues(containerId) {
  const checked = Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(cb => cb.value);
  return checked.length > 0 ? checked : Array.from(document.querySelectorAll(`#${containerId} input`)).map(cb => cb.value);
}

function isDateInRange(dateStr, range) {
  if (!range[0] || !range[1]) return true;
  const d = new Date(dateStr.split("/").reverse().join("-"));
  const ds = new Date(range[0].split("/").reverse().join("-"));
  const de = new Date(range[1].split("/").reverse().join("-"));
  return d >= ds && d <= de;
}

function applyFilters() {
  const customer = document.getElementById('customerFilter').value.toLowerCase();
  const dateRange = document.getElementById('dateRange').value.split(' - ');
  const filters = {
    salesman: getCheckedValues('salesmanFilter'),
    product: getCheckedValues('productFilter'),
    region: getCheckedValues('regionFilter'),
    quarter: getCheckedValues('quarterFilter'),
    year: getCheckedValues('yearFilter')
  };

  const filtered = originalData.filter(row => {
    return (!customer || (row['Kh√°ch h√†ng'] || '').toLowerCase().includes(customer)) &&
           isDateInRange(row['Ng√†y giao d·ªãch'], dateRange) &&
           filters.salesman.includes(row['Salesman']) &&
           filters.product.includes(row['S·∫£n ph·∫©m']) &&
           filters.region.includes(row['V√πng mi·ªÅn']) &&
           filters.quarter.includes(row['Qu√Ω']) &&
           filters.year.includes(row['NƒÉm']);
  });
  table.setData(filtered);
}

function setupLiveFilterEvents() {
  document.querySelectorAll('#filters input').forEach(el => {
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });
}

document.getElementById('btn-toggle-cols').addEventListener('click', () => table.toggleColumnChooser());
document.getElementById('btn-export').addEventListener('click', () => table.download("xlsx", "bao_cao_ban_hang.xlsx"));

window.onload = () => {
  const email = localStorage.getItem("report_email") || prompt("Nh·∫≠p email:");
  const token = localStorage.getItem("report_token") || prompt("Nh·∫≠p token:");
  fetchDataJSONP(email, token);
  new Litepicker({ element: document.getElementById("dateRange"), singleMode: false, format: "DD/MM/YYYY" });
};
</script>
</body>
</html>
