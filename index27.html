<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo Cáo Bán Hàng</title>
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    #wrapper { display: flex; height: 100vh; }
    #filters { width: 18%; padding: 1rem; background: #f8f9fa; overflow-y: auto; border-right: 2px solid #3f8384; }
    #reportArea { width: 82%; display: flex; flex-direction: column; overflow: hidden; }
    #reportTable { flex: 1; overflow-x: auto; }
    h4, label { color: #3f8384; }
    .tabulator .tabulator-header .tabulator-col { background: #3f8384; color: white; text-align: center; }
    .tabulator .tabulator-row .tabulator-cell.numeric { text-align: right; }
    .filter-group { margin-bottom: 12px; }
    .checkbox-group { border: 1px solid #ccc; max-height: 120px; overflow-y: auto; background: #fff; padding: 5px; }
    #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; display: none; }
    #col-toggle-list { position:absolute; top:100%; right:0; background:#fff; border:1px solid #ccc; z-index:1000; display:none; max-height:300px; overflow:auto; width:250px; }
  </style>
</head>
<body>
<div id="loading">Đang tải dữ liệu...</div>
<div id="wrapper">
  <div id="filters">
    <h4>Bộ Lọc</h4>
    <label>Ngày giao dịch</label>
    <input id="dateRange" class="form-control mb-2" />
    <label>Khách hàng</label>
    <input id="customerFilter" class="form-control mb-2" placeholder="Tên khách hàng" />
    <div class="filter-group"><label>Salesman</label><div id="salesmanFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Sản phẩm</label><div id="productFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Vùng miền</label><div id="regionFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Quý</label><div id="quarterFilter" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Năm</label><div id="yearFilter" class="checkbox-group"></div></div>
  </div>

  <div id="reportArea">
    <h2 class="text-center text-primary mt-2">CHI TIẾT HIỆU QUẢ BÁN HÀNG</h2>
    <div class="d-flex justify-content-end px-3 mb-2" style="position: relative;">
      <div class="dropdown">
        <button id="btn-toggle-cols" class="btn btn-outline-primary btn-sm me-2">Ẩn/Hiện Cột</button>
        <div id="col-toggle-list" class="card p-2"></div>
      </div>
      <button id="btn-export" class="btn btn-success btn-sm">Xuất Excel</button>
    </div>
    <div id="reportTable"></div>
  </div>
</div>

<script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rQxWIbh49/exec';
let table, originalData = [];
let currentEmail = "", currentToken = "";

const numericCols = ["Số lượng", "Doanh thu thuần", "Đơn giá", "COGS", "Lãi Gộp", "Chi phí giao hàng", "Lãi vay"];
const percentCols = ["% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"];
const subtotalCols = ["Số lượng", "Doanh thu thuần", "COGS", "Lãi Gộp", "Chi phí giao hàng", "Lãi vay"];
const defaultVisibleCols = [
  "Khách hàng", "Loại giao dịch", "Sản phẩm", "Mã lô hàng", "Tên hàng",
  "Số lượng", "Đơn giá", "Doanh thu thuần", "COGS", "Lãi Gộp", "Chi phí giao hàng", "Lãi vay"
];

function showLoading(show = true) {
  document.getElementById("loading").style.display = show ? "flex" : "none";
}

function myCallback(data) {
  showLoading(false);

  if (!Array.isArray(data) || data.length === 0) {
    alert("Sai email hoặc token. Vui lòng nhập lại.");
    localStorage.removeItem("report_email");
    localStorage.removeItem("report_token");
    location.reload();
    return;
  }

  localStorage.setItem("report_email", currentEmail);
  localStorage.setItem("report_token", currentToken);

  originalData = data.map(row => {
    if (row["Ngày giao dịch"]?.includes("T")) {
      const d = new Date(row["Ngày giao dịch"]);
      row["Ngày giao dịch"] = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    }
    return row;
  });

  buildFilters(originalData);

  const columns = Object.keys(originalData[0]).map(key => ({
    title: key,
    field: key,
    hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left',
    cssClass: numericCols.includes(key) ? 'numeric' : '',
    formatter: numericCols.includes(key)
      ? cell => Number(cell.getValue()).toLocaleString('en-US')
      : percentCols.includes(key)
      ? cell => `${Number(cell.getValue()).toFixed(2)}%`
      : undefined,
    bottomCalc: key === 'Giá bán net'
      ? (values, data) => {
          const tongDT = data.reduce((s, r) => s + (r['Doanh thu thuần'] || 0), 0);
          const tongSL = data.reduce((s, r) => s + (r['Số lượng'] || 0), 0);
          return tongSL ? (tongDT / tongSL).toLocaleString('en-US') : 0;
        }
      : subtotalCols.includes(key) ? "sum" : undefined
  }));

  table = new Tabulator("#reportTable", {
    data: originalData,
    columns,
    layout: "fitDataFill",
    height: "100%",
    placeholder: "Không có dữ liệu",
    responsiveLayout: true
  });

  renderColumnToggleControls(columns);
  setupLiveFilterEvents();
}

function fetchDataJSONP(email, token) {
  showLoading(true);
  currentEmail = email;
  currentToken = token;
  const script = document.createElement('script');
  script.src = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`;
  document.body.appendChild(script);
}

function buildFilters(data) {
  const fieldMap = {
    "Salesman": "salesmanFilter",
    "Sản phẩm": "productFilter",
    "Vùng miền": "regionFilter",
    "Quý": "quarterFilter",
    "Năm": "yearFilter"
  };
  for (let field in fieldMap) {
    const id = fieldMap[field];
    const container = document.getElementById(id);
    if (!container) continue;
    const unique = [...new Set(data.map(r => r[field]).filter(Boolean))];
    container.innerHTML = unique.map(v => `<div><label><input type="checkbox" value="${v}" checked /> ${v}</label></div>`).join('');
  }
}

function getCheckedValues(containerId) {
  const checked = Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(cb => cb.value);
  return checked.length > 0 ? checked : Array.from(document.querySelectorAll(`#${containerId} input`)).map(cb => cb.value);
}

function isDateInRange(dateStr, range) {
  if (!range[0] || !range[1]) return true;
  const d = new Date(dateStr.split("/").reverse().join("-"));
  const ds = new Date(range[0].split("/").reverse().join("-"));
  const de = new Date(range[1].split("/").reverse().join("-"));
  return d >= ds && d <= de;
}

function applyFilters() {
  const customer = document.getElementById('customerFilter').value.toLowerCase();
  const dateRange = document.getElementById('dateRange').value.split(' - ');
  const filtered = originalData.filter(row => {
    return (!customer || (row['Khách hàng'] || '').toLowerCase().includes(customer)) &&
           isDateInRange(row['Ngày giao dịch'], dateRange) &&
           getCheckedValues('salesmanFilter').includes(row['Salesman']) &&
           getCheckedValues('productFilter').includes(row['Sản phẩm']) &&
           getCheckedValues('regionFilter').includes(row['Vùng miền']) &&
           getCheckedValues('quarterFilter').includes(row['Quý']) &&
           getCheckedValues('yearFilter').includes(row['Năm']);
  });
  table.setData(filtered);
}

function setupLiveFilterEvents() {
  document.querySelectorAll('#filters input').forEach(el => {
    el.addEventListener('input', applyFilters);
    el.addEventListener('change', applyFilters);
  });
}

function renderColumnToggleControls(columns) {
  const container = document.getElementById("col-toggle-list");
  container.innerHTML = columns.map(col => {
    const checked = defaultVisibleCols.includes(col.title) ? "checked" : "";
    return `<div><label><input type="checkbox" data-col="${col.field}" ${checked}/> ${col.title}</label></div>`;
  }).join("");

  // Ẩn các cột không mặc định
  columns.forEach(col => {
    if (!defaultVisibleCols.includes(col.title)) {
      table.hideColumn(col.field);
    }
  });

  container.querySelectorAll("input[type='checkbox']").forEach(input => {
    input.addEventListener("change", () => {
      const col = table.getColumn(input.dataset.col);
      if (input.checked) {
        table.showColumn(col);
        table.moveColumn(col, table.getColumns().length); // chuyển về cuối
      } else {
        table.hideColumn(col);
      }
    });
  });
}

document.getElementById('btn-toggle-cols').addEventListener('click', () => {
  const box = document.getElementById("col-toggle-list");
  box.style.display = box.style.display === "none" ? "block" : "none";
});
document.getElementById('btn-export').addEventListener('click', () => table.download("xlsx", "bao_cao_ban_hang.xlsx"));

window.onload = () => {
  const email = localStorage.getItem("report_email") || prompt("Nhập email:");
  const token = localStorage.getItem("report_token") || prompt("Nhập token:");
  fetchDataJSONP(email, token);
  new Litepicker({ element: document.getElementById("dateRange"), singleMode: false, format: "DD/MM/YYYY" });
};
</script>
</body>
</html>
