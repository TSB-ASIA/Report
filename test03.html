<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo Cáo Bán Hàng Tương Tác</title>
  <!-- Các file CSS thư viện -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  
  <!-- CSS Tùy chỉnh cho Báo cáo -->
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background-color: #e9ecef; }
    #wrapper { display: flex; height: 100vh; }
    #filters { width: 18%; padding: 1rem; background: #f8f9fa; overflow-y: auto; border-right: 2px solid #3f8384; flex-shrink: 0; }
    #reportArea { 
        width: 82%; 
        display: flex; 
        flex-direction: column; 
        overflow-y: auto;
        position: relative;
        padding: 0 1rem;
    }
    
    /* --- SỬA LỖI: CỐ ĐỊNH CHIỀU CAO VÀ NGĂN CO RÚT --- */
    #reportTable { 
        width: 100%; 
        border: 1px solid #ddd; 
        margin-bottom: 2rem;
        height: 800px; /* Cố định chiều cao */
        flex-shrink: 0; /* Rất quan trọng: Ngăn flexbox co nhỏ bảng */
    }

    h4, label { color: #3f8384; font-weight: bold; }
    .tabulator .tabulator-header .tabulator-col { background: #3f8384; color: white; text-align: center; }
    .tabulator .tabulator-header .tabulator-col.tabulator-col-movable { cursor: move; }
    .tabulator .tabulator-row .tabulator-cell.numeric { text-align: right; }
    .filter-group { margin-bottom: 12px; }
    .checkbox-group { border: 1px solid #ccc; max-height: 120px; overflow-y: auto; background: #fff; padding: 5px; }
    #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; display: none; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
    .modal-body { overflow-y: auto; margin-bottom: 15px; }
    .modal-footer { text-align: right; border-top: 1px solid #ccc; padding-top: 15px; }
    #column-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
    .select-controls { font-size: 0.8em; font-weight: normal; margin-left: 8px; }
    .select-controls a { text-decoration: none; color: #0d6efd; }
    .select-controls a:hover { text-decoration: underline; }
    #company-logo { position: absolute; top: 10px; left: 20px; opacity: 0.8; }
    
    #chartsDashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding-bottom: 2rem; }
    .chart-container { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-height: 400px; }
    .chart-container h6 { margin-bottom: 15px; text-align: center; color: #343a40; font-weight: bold; }
    .chart-canvas-container { position: relative; flex-grow: 1; }

    @media (max-width: 1200px) { #chartsDashboard { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<div id="loading">Đang tải dữ liệu...</div>

<div id="column-selector-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Tùy chọn hiển thị cột</h5></div>
    <div class="modal-body"><div id="column-list"></div></div>
    <div class="modal-footer">
      <button id="btn-cancel-selection" class="btn btn-secondary btn-sm">Hủy</button>
      <button id="btn-apply-selection" class="btn btn-primary btn-sm">Áp dụng</button>
    </div>
  </div>
</div>

<div id="wrapper">
  <div id="filters">
    <h4>BỘ LỌC</h4>
    <label for="dateRange">Ngày giao dịch</label>
    <input id="dateRange" class="form-control mb-2" />
    <label for="customerFilter">Khách hàng</label>
    <input id="customerFilter" class="form-control mb-2" placeholder="Tên khách hàng" />
    <label for="batchFilter">Mã lô hàng</label>
    <input id="batchFilter" class="form-control mb-2" placeholder="Mã lô hàng" />
    <div class="filter-group"><label>Salesman</label><div id="salesman-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Nhóm sản Phẩm</label><div id="nhom-san-pham-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Loại xuất</label><div id="loai-xuat-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Sản phẩm</label><div id="product-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Vùng miền</label><div id="region-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Quý</label><div id="quarter-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Năm</label><div id="year-filter-container" class="checkbox-group"></div></div>
  </div>

  <div id="reportArea">
    <img id="company-logo" src="https://i.imgur.com/DrxQhMN.png" alt="Company Logo" style='width:129px; height:50px';>
    <h2 class="text-center text-primary mt-2"><strong>CHI TIẾT HIỆU QUẢ BÁN HÀNG</strong></h2>
    <div class="d-flex justify-content-end align-items-center px-3 mb-2">
      <button id="btn-save-layout" class="btn btn-info btn-sm me-2">Lưu Cấu hình</button>
      <button id="btn-reset-layout" class="btn btn-warning btn-sm me-2">Reset Cấu hình</button>
      <button id="btn-toggle-cols" class="btn btn-outline-primary btn-sm me-2">Chọn/Bỏ chọn Cột</button>
      <button id="btn-export" class="btn btn-success btn-sm">Xuất Excel</button>
    </div>
    
    <div id="reportTable"></div>

    <div id="chartsDashboard">
      <div class="chart-container"><h6>1. Xu hướng Số lượng bán theo Tháng</h6><div class="chart-canvas-container"><canvas id="chart1"></canvas></div></div>
      <div class="chart-container"><h6>2. Top 5 Salesman theo Doanh thu</h6><div class="chart-canvas-container"><canvas id="chart2"></canvas></div></div>
      <div class="chart-container"><h6>3. Cơ cấu Sản phẩm theo Số lượng</h6><div class="chart-canvas-container"><canvas id="chart3"></canvas></div></div>
      <div class="chart-container"><h6>4. Cơ cấu Sản phẩm theo Doanh thu</h6><div class="chart-canvas-container"><canvas id="chart4"></canvas></div></div>
      <div class="chart-container"><h6>5. Cơ cấu Doanh thu theo Nhóm SP</h6><div class="chart-canvas-container"><canvas id="chart5"></canvas></div></div>
      <div class="chart-container"><h6>6. Cơ cấu Lãi gộp theo Nhóm SP</h6><div class="chart-canvas-container"><canvas id="chart6"></canvas></div></div>
      <div class="chart-container"><h6>7. Lãi gộp theo Vùng miền</h6><div class="chart-canvas-container"><canvas id="chart7"></canvas></div></div>
      <div class="chart-container"><h6>8. CP Giao hàng theo Nhóm SP</h6><div class="chart-canvas-container"><canvas id="chart8"></canvas></div></div>
      <div class="chart-container"><h6>9. Lãi vay theo Nhóm SP</h6><div class="chart-canvas-container"><canvas id="chart9"></canvas></div></div>
      <div class="chart-container"><h6>10. Lãi vay theo Sản phẩm</h6><div class="chart-canvas-container"><canvas id="chart10"></canvas></div></div>
    </div>
  </div>
</div>

<!-- Các thư viện JS -->
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>
// --- Các hằng số và biến toàn cục ---
const API_URL = 'https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rQxWIbh49/exec';
const COLUMN_CONFIG_KEY = 'salesReportColumnConfig';
let table, originalData = [];
let allColumnDefinitions = [];
let currentEmail = "", currentToken = "";
let charts = {};
Chart.register(ChartDataLabels);
const numericCols = ["Số lượng", "Doanh thu thuần", "Đơn giá", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Giá bán net", "Giá bán tiêu chuẩn", "Lãi gộp tính lương B2B", "LK tiêu chuẩn", "Điều chỉnh lương khoán KD", "Lương khoán tối thiểu", "Lương khoán/kg", "LK Đức HM", "Lương khoán sales"];
const percentCols = ["% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"];
const subtotalCols = ["Số lượng", "Doanh thu thuần", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Lãi gộp tính lương B2B", "LK Đức HM", "Lương khoán sales"];
const FILTER_CONFIG = [
  { field: 'Salesman', containerId: 'salesman-filter-container' }, { field: 'Nhóm sản Phẩm', containerId: 'nhom-san-pham-filter-container' }, { field: 'Loại xuất', containerId: 'loai-xuat-filter-container' }, { field: 'Sản phẩm', containerId: 'product-filter-container' }, { field: 'Vùng miền', containerId: 'region-filter-container' }, { field: 'Quý', containerId: 'quarter-filter-container' }, { field: 'Năm', containerId: 'year-filter-container' }
];
const CHART_PRIMARY_COLOR = '#3f8384';
const VIBRANT_CHART_PALETTE = ['#4E79A7', '#F28E2B', '#E15759', '#76B7B2', '#59A14F', '#EDC948', '#AF7AA1', '#FF9DA7', '#9C755F', '#BAB0AC', '#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd'];

// --- Các hàm xử lý chính ---
function myCallback(data) {
  showLoading(false); if (!Array.isArray(data) || (Array.isArray(data) && data.length > 0 && typeof data[0] !== 'object')) { alert("Sai email hoặc token. Vui lòng nhập lại."); localStorage.removeItem("report_email"); localStorage.removeItem("report_token"); location.reload(); return; } localStorage.setItem("report_email", currentEmail); localStorage.setItem("report_token", currentToken); originalData = data.map(row => { if (row["Ngày giao dịch"] && typeof row["Ngày giao dịch"] === 'string' && row["Ngày giao dịch"].includes("T")) { const d = new Date(row["Ngày giao dịch"]); row["Ngày giao dịch"] = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; } numericCols.forEach(col => { if(row[col]) row[col] = parseFloat(row[col]) || 0; }); return row; }); if (originalData.length === 0) { document.getElementById('reportTable').innerHTML = '<div class="alert alert-info text-center mt-4">Không có dữ liệu nào để hiển thị.</div>'; return; } buildFilters(originalData); buildTable(originalData); initializeAllCharts(originalData); setupLiveFilterEvents();
}

function buildTable(data) {
    allColumnDefinitions = Object.keys(data[0]).map(key => { const columnDef = { title: key, field: key, hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left', cssClass: numericCols.includes(key) ? 'numeric' : '', formatter: percentCols.includes(key) ? cell => cell.getValue() != null ? `${(Number(cell.getValue()) * 100).toFixed(2)}%` : '' : numericCols.includes(key) ? cell => cell.getValue() != null ? Number(cell.getValue()).toLocaleString('en-US', { maximumFractionDigits: 0 }) : '' : undefined, bottomCalc: undefined }; if (key === 'Khách hàng' || key === 'Số đơn hàng') { columnDef.bottomCalc = "unique"; } else if (key === '% lương Khoán') { columnDef.bottomCalc = (values, data) => { const totalSales = data.reduce((sum, row) => sum + (row["Lương khoán sales"] || 0), 0); const totalRevenue = data.reduce((sum, row) => sum + (row["Doanh thu thuần"] || 0), 0); if(totalRevenue === 0) return "0.00%"; const percentage = (totalSales / totalRevenue) * 100; return `${percentage.toFixed(2)}%`; }; } else if (key === 'Giá bán net') { columnDef.bottomCalc = (values, data) => { const tongDT = data.reduce((s, r) => s + (r['Doanh thu thuần'] || 0), 0); const tongSL = data.reduce((s, r) => s + (r['Số lượng'] || 0), 0); return tongSL ? (tongDT / tongSL).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 0; }; } else if (subtotalCols.includes(key)) { columnDef.bottomCalc = "sum"; } if (key === 'Khách hàng' || key === 'Số đơn hàng') { columnDef.bottomCalcFormatter = function(cell){ const value = cell.getValue(); return `<div style="text-align: center;">${value}</div>`; } } else if (subtotalCols.includes(key)) { columnDef.bottomCalcFormatter = "money"; columnDef.bottomCalcFormatterParams = { thousand: ",", precision: 0 }; } return columnDef; }); 
    let initialColumns = allColumnDefinitions; 
    const savedConfigJSON = localStorage.getItem(COLUMN_CONFIG_KEY); 
    if (savedConfigJSON) { try { const savedFields = JSON.parse(savedConfigJSON); const savedDefs = savedFields.map(field => allColumnDefinitions.find(def => def.field === field)).filter(Boolean); if (savedDefs.length > 0) { initialColumns = savedDefs; } } catch (e) { console.error("Lỗi khi tải cấu hình cột:", e); localStorage.removeItem(COLUMN_CONFIG_KEY); } } 
    
    table = new Tabulator("#reportTable", { 
        data: data, 
        columns: initialColumns, 
        // height: "600px", // <<< XÓA DÒNG NÀY Ở ĐÂY để CSS quản lý
        movableColumns: true, 
        placeholder: "Không có dữ liệu phù hợp với bộ lọc.", 
        rowFormatter: row => { if (row.getData()["Salesman"] === "TỔNG CỘNG") { row.getElement().style.backgroundColor = "#e0f0ff"; row.getElement().style.fontWeight = "bold"; } }, 
        columnDefaults: { tooltip: true } 
    });
}

function applyFilters() { 
  const customerFilterValue = document.getElementById('customerFilter').value.toLowerCase().trim(); const batchFilterValue = document.getElementById('batchFilter').value.toLowerCase().trim(); const dateRangeInput = document.getElementById('dateRange'); const dateRangeValue = dateRangeInput.value ? dateRangeInput.value.split(' - ') : []; const filteredData = originalData.filter(row => { const customerMatch = String(row['Khách hàng'] || '').toLowerCase().includes(customerFilterValue); const batchMatch = String(row['Mã lô hàng'] || '').toLowerCase().includes(batchFilterValue); const dateMatch = !dateRangeInput.value || isDateInRange(row['Ngày giao dịch'], dateRangeValue); const checkboxMatch = FILTER_CONFIG.every(config => { const allCheckboxes = document.querySelectorAll(`#${config.containerId} input[type="checkbox"]`); if (allCheckboxes.length === 0) return true; const checkedValues = getCheckedValues(config.containerId); if (checkedValues.length === 0) return false; const rowValue = String(row[config.field] || ''); return checkedValues.includes(rowValue); }); return customerMatch && batchMatch && dateMatch && checkboxMatch; }); if (table) { table.setData(filteredData); } updateAllCharts(filteredData);
}
function groupAndAggregate(data, groupByField, aggregateField) {
    if (!data || data.length === 0) return []; const grouped = data.reduce((acc, row) => { const key = row[groupByField] || 'Không xác định'; const value = parseFloat(row[aggregateField]) || 0; if (!acc[key]) { acc[key] = 0; } acc[key] += value; return acc; }, {}); return Object.entries(grouped).map(([label, value]) => ({ label, value })).sort((a, b) => b.value - a.value);
}
function initializeAllCharts(data) {
    const chartConfigs = [ { id: 'chart1', type: 'line', dataFn: (d) => processChart1Data(d) }, { id: 'chart2', type: 'bar', dataFn: (d) => processChart2Data(d), options: { indexAxis: 'y' } }, { id: 'chart3', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Sản phẩm', 'Số lượng', true) }, { id: 'chart4', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Sản phẩm', 'Doanh thu thuần', true) }, { id: 'chart5', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Doanh thu thuần', true) }, { id: 'chart6', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Lãi gộp', true) }, { id: 'chart7', type: 'bar', dataFn: (d) => processChartGenericData(d, 'Vùng miền', 'Lãi gộp', false) }, { id: 'chart8', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Chi phí giao hàng', true) }, { id: 'chart9', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Lãi vay', true) }, { id: 'chart10', type: 'doughnut', dataFn: (d) => processChartGenericData(d, 'Sản phẩm', 'Lãi vay', true) }, ];
    chartConfigs.forEach(config => { const ctx = document.getElementById(config.id).getContext('2d'); const chartData = config.dataFn(data); const datalabelsConfig = getDatalabelsConfig(config.type); charts[config.id] = new Chart(ctx, { type: config.type, data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: config.type === 'doughnut', position: 'bottom', labels: { boxWidth: 12, padding: 15 } }, datalabels: datalabelsConfig }, ...config.options } }); });
}
function updateAllCharts(filteredData) {
    if (Object.keys(charts).length === 0) return;
    const chartUpdaters = { 'chart1': (d) => processChart1Data(d), 'chart2': (d) => processChart2Data(d), 'chart3': (d) => processChartGenericData(d, 'Sản phẩm', 'Số lượng', true), 'chart4': (d) => processChartGenericData(d, 'Sản phẩm', 'Doanh thu thuần', true), 'chart5': (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Doanh thu thuần', true), 'chart6': (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Lãi gộp', true), 'chart7': (d) => processChartGenericData(d, 'Vùng miền', 'Lãi gộp', false), 'chart8': (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Chi phí giao hàng', true), 'chart9': (d) => processChartGenericData(d, 'Nhóm sản Phẩm', 'Lãi vay', true), 'chart10': (d) => processChartGenericData(d, 'Sản phẩm', 'Lãi vay', true), };
    for (const id in chartUpdaters) { const chart = charts[id]; const newChartData = chartUpdaters[id](filteredData); chart.data.labels = newChartData.labels; chart.data.datasets[0].data = newChartData.datasets[0].data; if(chart.config.type === 'doughnut' || (chart.config.type === 'bar' && id === 'chart2')) { chart.data.datasets[0].backgroundColor = VIBRANT_CHART_PALETTE.slice(0, newChartData.labels.length); } chart.update(); }
}
function getDatalabelsConfig(type) {
    if (type === 'doughnut') { return { formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); const percentage = total > 0 ? (value / total) * 100 : 0; return percentage > 3 ? percentage.toFixed(1) + '%' : null; }, color: '#fff', font: { weight: 'bold', size: 12 } }; }
    return { align: 'end', anchor: 'end', formatter: (value) => value > 0 ? value.toLocaleString('en-US') : null, font: { size: 10 }, color: '#555' };
}
function processChart1Data(data) {
    const monthlyData = data.reduce((acc, row) => { if (!row['Ngày giao dịch']) return acc; try { const [, month, year] = row['Ngày giao dịch'].split('/'); const monthYear = `${month}/${year}`; if (!acc[monthYear]) { acc[monthYear] = { value: 0, date: new Date(`${year}-${month}-01`) }; } acc[monthYear].value += parseFloat(row['Số lượng']) || 0; } catch(e) {} return acc; }, {}); const sortedMonths = Object.entries(monthlyData).sort(([, a], [, b]) => a.date - b.date).map(([label, {value}]) => ({ label, value })); return { labels: sortedMonths.map(d => d.label), datasets: [{ label: 'Tổng Số lượng', data: sortedMonths.map(d => d.value), borderColor: CHART_PRIMARY_COLOR, backgroundColor: 'rgba(63, 131, 132, 0.2)', fill: true, tension: 0.1 }] };
}
function processChart2Data(data) {
    const processedData = groupAndAggregate(data, 'Salesman', 'Doanh thu thuần').slice(0, 5); return { labels: processedData.map(d => d.label), datasets: [{ label: 'Doanh thu thuần', data: processedData.map(d => d.value), backgroundColor: VIBRANT_CHART_PALETTE }] };
}
function processChartGenericData(data, groupBy, aggregateBy, useVibrantPalette) {
    const processedData = groupAndAggregate(data, groupBy, aggregateBy); const backgroundColor = useVibrantPalette ? VIBRANT_CHART_PALETTE.slice(0, processedData.length) : CHART_PRIMARY_COLOR; return { labels: processedData.map(d => d.label), datasets: [{ label: aggregateBy, data: processedData.map(d => d.value), backgroundColor: backgroundColor }] };
}

// --- CÁC HÀM TIỆN ÍCH KHÁC (GIỮ NGUYÊN) ---
function setupLiveFilterEvents() { document.getElementById('customerFilter').addEventListener('input', applyFilters); document.getElementById('batchFilter').addEventListener('input', applyFilters); document.querySelectorAll('.filter-group').forEach(group => { group.addEventListener('click', (e) => { const target = e.target; if (target.tagName === 'A' && (target.classList.contains('select-all') || target.classList.contains('deselect-all'))) { e.preventDefault(); const containerId = target.dataset.target; const checkStatus = target.classList.contains('select-all'); if (containerId) { document.querySelectorAll(`#${containerId} input[type="checkbox"]`).forEach(cb => cb.checked = checkStatus); applyFilters(); } } }); const checkboxGroup = group.querySelector('.checkbox-group'); if (checkboxGroup) { checkboxGroup.addEventListener('change', applyFilters); } }); new Litepicker({ element: document.getElementById('dateRange'), singleMode: false, format: "DD/MM/YYYY", autoApply: false, setup: (picker) => { picker.on('selected', () => applyFilters()); picker.on('clear:selection', () => applyFilters()); } }); }
function showLoading(show = true) { document.getElementById("loading").style.display = show ? "flex" : "none"; }
function showColumnSelector() { const modal = document.getElementById('column-selector-modal'); const columnListDiv = document.getElementById('column-list'); const currentColumns = table.getColumns(true); const visibleColumnFields = table.getColumns().map(c => c.getField()); columnListDiv.innerHTML = ''; currentColumns.forEach(column => { const field = column.getField(); const definition = column.getDefinition(); const isVisible = visibleColumnFields.includes(field); const wrapper = document.createElement('div'); wrapper.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="${field}" id="col-${field}" ${isVisible ? 'checked' : ''}><label class="form-check-label" for="col-${field}">${definition.title}</label></div>`; columnListDiv.appendChild(wrapper); }); modal.style.display = 'flex'; }
function applyColumnSelection() { const selectedFields = Array.from(document.querySelectorAll('#column-list input:checked')).map(cb => cb.value); if (selectedFields.length > 0) { const newColumns = selectedFields.map(field => allColumnDefinitions.find(def => def.field === field)).filter(Boolean); table.setColumns(newColumns); } else { alert("Bạn phải chọn ít nhất một cột để hiển thị."); } closeColumnSelector(); }
function closeColumnSelector() { document.getElementById('column-selector-modal').style.display = 'none'; }
function fetchDataJSONP(email, token) { showLoading(true); currentEmail = email; currentToken = token; const script = document.createElement('script'); script.src = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`; script.onerror = () => { showLoading(false); alert("Lỗi kết nối tới máy chủ dữ liệu."); document.getElementById('reportTable').innerHTML = '<div class="alert alert-danger text-center mt-4">Không thể tải dữ liệu.</div>'; }; document.body.appendChild(script); }
function buildFilters(data) { FILTER_CONFIG.forEach(config => { const filterGroup = document.getElementById(config.containerId)?.parentElement; if(filterGroup) filterGroup.style.display = ''; if (data.length > 0 && data[0].hasOwnProperty(config.field)) { const container = document.getElementById(config.containerId); if (container) { const uniqueValues = [...new Set(data.map(r => r[config.field]).filter(val => val !== null && val !== undefined))].sort(); if (uniqueValues.length > 0) { const oldControls = container.previousElementSibling.querySelector('.select-controls'); if (oldControls) oldControls.remove(); container.innerHTML = uniqueValues.map(v => { const label = v === '' ? '(Trống)' : v; return `<div><label><input type="checkbox" value="${v}" checked /> ${label}</label></div>`; }).join(''); const labelElement = container.previousElementSibling; if (labelElement && labelElement.tagName === 'LABEL') { const controls = document.createElement('span'); controls.className = 'select-controls'; controls.innerHTML = `(<a href="#" class="select-all" data-target="${config.containerId}">Tất cả</a> | <a href="#" class="deselect-all" data-target="${config.containerId}">Bỏ chọn</a>)`; labelElement.appendChild(controls); } } else { container.parentElement.style.display = 'none'; } } } else { const container = document.getElementById(config.containerId); if (container) container.parentElement.style.display = 'none'; } }); }
function getCheckedValues(containerId) { return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]`)).filter(cb => cb.checked).map(cb => cb.value); }
function isDateInRange(dateStr, range) { if (!dateStr || !range || range.length < 2) return false; try { const [day, month, year] = dateStr.split('/'); const date = new Date(`${year}-${month}-${day}`); const startDate = new Date(range[0].split('/').reverse().join('-')); const endDate = new Date(range[1].split('/').reverse().join('-')); return date >= startDate && date <= endDate; } catch(e) { return false; } }
window.onload = () => { const email = localStorage.getItem("report_email") || prompt("Nhập email:"); const token = localStorage.getItem("report_token") || prompt("Nhập token:"); if (!email || !token) { showLoading(false); document.getElementById('reportTable').innerHTML = '<div class="alert alert-warning text-center mt-4">Yêu cầu xác thực không thành công.</div>'; return; } fetchDataJSONP(email, token); };
document.getElementById('btn-toggle-cols').addEventListener('click', () => { if (table) showColumnSelector(); else alert("Vui lòng đợi dữ liệu tải xong."); });
document.getElementById('btn-export').addEventListener('click', () => { if (table) table.download("xlsx", "bao_cao_ban_hang.xlsx", { sheetName: "BaoCaoBanHang" }); else alert("Không có dữ liệu để xuất."); });
document.getElementById('btn-apply-selection').addEventListener('click', applyColumnSelection);
document.getElementById('btn-cancel-selection').addEventListener('click', closeColumnSelector);
document.getElementById('column-selector-modal').addEventListener('click', (e) => { if (e.target.id === 'column-selector-modal') closeColumnSelector(); });
document.getElementById('btn-save-layout').addEventListener('click', () => { if (!table) return alert("Vui lòng đợi dữ liệu tải xong."); const currentVisibleColumns = table.getColumns().map(c => c.getField()); localStorage.setItem(COLUMN_CONFIG_KEY, JSON.stringify(currentVisibleColumns)); alert("Cấu hình cột đã được lưu thành công!"); });
document.getElementById('btn-reset-layout').addEventListener('click', () => { if (!table) return alert("Vui lòng đợi dữ liệu tải xong."); if (confirm('Bạn có chắc muốn xóa cấu hình đã lưu và quay về mặc định không?')) { localStorage.removeItem(COLUMN_CONFIG_KEY); table.setColumns(allColumnDefinitions); alert("Cấu hình cột đã được trả về mặc định."); } });
</script>
</body>
</html>
