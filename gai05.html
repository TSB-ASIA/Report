<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo Cáo Bán Hàng</title>
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; margin: 0; }
    #wrapper { display: flex; height: 100vh; }
    #filters { width: 18%; padding: 1rem; background: #f8f9fa; overflow-y: auto; border-right: 2px solid #3f8384; flex-shrink: 0; }
    #reportArea { width: 82%; display: flex; flex-direction: column; overflow: hidden; }
    #reportTable { flex: 1; overflow: auto; }
    h4, label { color: #3f8384; font-weight: bold; }
    .tabulator .tabulator-header .tabulator-col { background: #3f8384; color: white; text-align: center; }
    .tabulator .tabulator-row .tabulator-cell.numeric { text-align: right; }
    .filter-group { margin-bottom: 12px; }
    .checkbox-group { border: 1px solid #ccc; max-height: 120px; overflow-y: auto; background: #fff; padding: 5px; }
    #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; display: none; }
    
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); z-index: 10000;
      display: none; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 600px; max-height: 80vh;
      display: flex; flex-direction: column;
    }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
    .modal-body { overflow-y: auto; margin-bottom: 15px; }
    .modal-footer { text-align: right; border-top: 1px solid #ccc; padding-top: 15px; }
    #column-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
  </style>
</head>
<body>
<div id="loading">Đang tải dữ liệu...</div>

<div id="column-selector-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Tùy chọn hiển thị cột</h5>
    </div>
    <div class="modal-body">
      <div id="column-list"></div>
    </div>
    <div class="modal-footer">
      <button id="btn-cancel-selection" class="btn btn-secondary btn-sm">Hủy</button>
      <button id="btn-apply-selection" class="btn btn-primary btn-sm">Áp dụng</button>
    </div>
  </div>
</div>

<div id="wrapper">
  <div id="filters">
    <h4>BỘ LỌC</h4>
    <label for="dateRange">Ngày giao dịch</label>
    <input id="dateRange" class="form-control mb-2" />
    <label for="customerFilter">Khách hàng</label>
    <input id="customerFilter" class="form-control mb-2" placeholder="Tên khách hàng" />
    <div class="filter-group"><label>Salesman</label><div id="salesman-filter-container" class="checkbox-group"></div></div>
    <!-- ✅ BỔ SUNG: Thêm vị trí cho bộ lọc mới -->
    <div class="filter-group"><label>Nhóm sản Phẩm</label><div id="nhom-san-pham-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Loại xuất</label><div id="loai-xuat-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Sản phẩm</label><div id="product-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Vùng miền</label><div id="region-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Quý</label><div id="quarter-filter-container" class="checkbox-group"></div></div>
    <div class="filter-group"><label>Năm</label><div id="year-filter-container" class="checkbox-group"></div></div>
  </div>

  <div id="reportArea">
    <h2 class="text-center text-primary mt-2">CHI TIẾT HIỆU QUẢ BÁN HÀNG</h2>
    <div class="d-flex justify-content-end px-3 mb-2">
      <button id="btn-toggle-cols" class="btn btn-outline-primary btn-sm me-2">Chọn/Bỏ chọn Cột</button>
      <button id="btn-export" class="btn btn-success btn-sm">Xuất Excel</button>
    </div>
    <div id="reportTable"></div>
  </div>
</div>

<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rQxWIbh49/exec';
let table, originalData = [];
let allColumnDefinitions = [];
let currentEmail = "", currentToken = "";

const numericCols = ["Số lượng", "Doanh thu thuần", "Đơn giá", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Giá bán net", "Giá bán tiêu chuẩn", "Lãi gộp tính lương B2B", "LK tiêu chuẩn", "Điều chỉnh lương khoán KD", "Lương khoán tối thiểu", "Lương khoán/kg", "LK Đức HM", "Lương khoán sales"];
const percentCols = ["% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"];
const subtotalCols = ["Số lượng", "Doanh thu thuần", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Lãi gộp tính lương B2B", "LK Đức HM", "Lương khoán sales"];

// ✅ BỔ SUNG: Thêm bộ lọc mới vào cấu hình
const FILTER_CONFIG = [
  { field: 'Salesman',        containerId: 'salesman-filter-container' },
  { field: 'Nhóm sản Phẩm',   containerId: 'nhom-san-pham-filter-container' },
  { field: 'Loại xuất',       containerId: 'loai-xuat-filter-container' },
  { field: 'Sản phẩm',         containerId: 'product-filter-container' },
  { field: 'Vùng miền',       containerId: 'region-filter-container' },
  { field: 'Quý',             containerId: 'quarter-filter-container' },
  { field: 'Năm',             containerId: 'year-filter-container' }
];

// --- Các hàm khởi tạo và xử lý dữ liệu (giữ nguyên) ---
function showLoading(show = true) { /* ... */ }
function myCallback(data) { /* ... */ }

// ✅ SỬA LỖI: logic lọc được viết lại hoàn toàn để xử lý tất cả các trường hợp
function applyFilters() {
  const customerFilterValue = document.getElementById('customerFilter').value.toLowerCase().trim();
  const dateRangeInput = document.getElementById('dateRange');
  const dateRangeValue = dateRangeInput.value ? dateRangeInput.value.split(' - ') : [];
  
  const filteredData = originalData.filter(row => {
    // --- Lọc theo trường văn bản và ngày ---
    
    // ✅ SỬA LỖI: Đảm bảo bộ lọc khách hàng hoạt động chính xác
    // Chuyển đổi giá trị của dòng thành chuỗi để tìm kiếm an toàn, ngay cả khi giá trị là null/undefined
    const customerMatch = customerFilterValue === '' || String(row['Khách hàng'] || '').toLowerCase().includes(customerFilterValue);
    
    // ✅ SỬA LỖI: Đảm bảo bộ lọc ngày hoạt động khi bị xóa
    // Chỉ kiểm tra khoảng ngày KHI người dùng đã thực sự chọn một khoảng ngày
    const dateMatch = !dateRangeInput.value || isDateInRange(row['Ngày giao dịch'], dateRangeValue);

    // Nếu không khớp với các bộ lọc cơ bản, loại bỏ ngay lập tức
    if (!customerMatch || !dateMatch) return false;

    // --- Lọc theo các nhóm checkbox ---
    for (const config of FILTER_CONFIG) {
      const allCheckboxes = document.querySelectorAll(`#${config.containerId} input[type="checkbox"]`);
      
      // Chỉ xử lý nếu bộ lọc này có tồn tại trong dữ liệu
      if (allCheckboxes.length > 0) {
        const checkedValues = getCheckedValues(config.containerId);
        
        // Nếu không có checkbox nào được chọn, dòng này không khớp
        if (checkedValues.length === 0) return false;
        
        // Nếu không phải tất cả đều được chọn (tức là người dùng đã lọc),
        // và giá trị của dòng không nằm trong danh sách đã chọn -> dòng này không khớp.
        const rowValue = String(row[config.field]);
        if (!checkedValues.includes(rowValue)) {
            return false;
        }
      }
    }
    
    // Nếu dòng đã vượt qua tất cả các bộ lọc, giữ lại nó
    return true;
  });
  
  if (table) {
      table.setData(filteredData);
  }
}


// --- Dưới đây là toàn bộ code không thay đổi, chỉ để đảm bảo tính đầy đủ ---

function showLoading(show = true) {
  document.getElementById("loading").style.display = show ? "flex" : "none";
}

function myCallback(data) {
  showLoading(false);
  if (!Array.isArray(data) || (Array.isArray(data) && data.length > 0 && typeof data[0] !== 'object')) {
    alert("Sai email hoặc token. Vui lòng nhập lại.");
    localStorage.removeItem("report_email");
    localStorage.removeItem("report_token");
    location.reload();
    return;
  }
  localStorage.setItem("report_email", currentEmail);
  localStorage.setItem("report_token", currentToken);

  originalData = data.map(row => {
    if (row["Ngày giao dịch"] && typeof row["Ngày giao dịch"] === 'string' && row["Ngày giao dịch"].includes("T")) {
      const d = new Date(row["Ngày giao dịch"]);
      row["Ngày giao dịch"] = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    }
    return row;
  });

  if (originalData.length === 0) {
      document.getElementById('reportTable').innerHTML = '<div class="alert alert-info text-center mt-4">Không có dữ liệu nào để hiển thị.</div>';
      return;
  }

  buildFilters(originalData);

  allColumnDefinitions = Object.keys(originalData[0]).map(key => ({
    title: key, field: key,
    hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left',
    cssClass: numericCols.includes(key) ? 'numeric' : '',
    formatter: numericCols.includes(key) ? cell => cell.getValue() != null ? Number(cell.getValue()).toLocaleString('en-US', { maximumFractionDigits: 0 }) : '' :
               percentCols.includes(key) ? cell => cell.getValue() != null ? `${Number(cell.getValue()).toFixed(2)}%` : '' : undefined,
    bottomCalc: key === 'Giá bán net'
      ? (values, data) => {
          const tongDT = data.reduce((s, r) => s + (r['Doanh thu thuần'] || 0), 0);
          const tongSL = data.reduce((s, r) => s + (r['Số lượng'] || 0), 0);
          return tongSL ? (tongDT / tongSL).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 0;
        }
      : subtotalCols.includes(key) ? "sum" : undefined,
    bottomCalcFormatter: "money", bottomCalcFormatterParams: { thousand: ",", precision: 0 }
  }));

  table = new Tabulator("#reportTable", {
    data: originalData,
    columns: allColumnDefinitions,
    height: "100%",
    placeholder: "Không có dữ liệu phù hợp với bộ lọc.",
    rowFormatter: row => {
      if (row.getData()["Salesman"] === "TỔNG CỘNG") {
        row.getElement().style.backgroundColor = "#e0f0ff";
        row.getElement().style.fontWeight = "bold";
      }
    },
    columnDefaults: { tooltip: true }
  });
  
  setupLiveFilterEvents();
}

function fetchDataJSONP(email, token) {
  showLoading(true);
  currentEmail = email;
  currentToken = token;
  const script = document.createElement('script');
  script.src = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`;
  script.onerror = () => {
      showLoading(false);
      alert("Lỗi kết nối tới máy chủ dữ liệu. Vui lòng kiểm tra lại đường truyền mạng.");
      document.getElementById('reportTable').innerHTML = '<div class="alert alert-danger text-center mt-4">Không thể tải dữ liệu.</div>';
  };
  document.body.appendChild(script);
}

function buildFilters(data) {
  FILTER_CONFIG.forEach(config => {
    // Kiểm tra xem cột có tồn tại trong dữ liệu không
    if (data.length > 0 && data[0].hasOwnProperty(config.field)) {
        const container = document.getElementById(config.containerId);
        if (container) {
          const uniqueValues = [...new Set(data.map(r => r[config.field]).filter(Boolean))].sort();
          if (uniqueValues.length > 0) {
              container.innerHTML = uniqueValues.map(v => `<div><label><input type="checkbox" value="${v}" checked /> ${v}</label></div>`).join('');
          } else {
              container.parentElement.style.display = 'none'; // Ẩn luôn bộ lọc nếu không có giá trị
          }
        }
    } else {
        // Nếu cột không tồn tại, ẩn bộ lọc đó đi
        const container = document.getElementById(config.containerId);
        if (container) container.parentElement.style.display = 'none';
    }
  });
}

function getCheckedValues(containerId) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
}

function isDateInRange(dateStr, range) {
  if (!dateStr || !range || range.length < 2) return false;
  try {
    const [day, month, year] = dateStr.split('/');
    const date = new Date(`${year}-${month}-${day}`);
    const startDate = new Date(range[0].split('/').reverse().join('-'));
    const endDate = new Date(range[1].split('/').reverse().join('-'));
    return date >= startDate && date <= endDate;
  } catch(e) { return false; }
}

function setupLiveFilterEvents() {
    document.querySelectorAll('#filters input[type="text"]').forEach(el => {
        el.addEventListener('input', applyFilters);
    });
    document.querySelectorAll('#filters .checkbox-group').forEach(el => {
        el.addEventListener('change', applyFilters);
    });
    const pickerElement = document.getElementById('dateRange');
    const litepicker = new Litepicker({ 
        element: pickerElement, 
        singleMode: false, 
        format: "DD/MM/YYYY",
        autoApply: false, // Để nút Apply và Clear hiển thị
        setup: (picker) => {
            picker.on('selected', (date1, date2) => {
                applyFilters();
            });
            // Thêm sự kiện khi người dùng xóa ngày
            picker.on('clear:selection', () => {
                applyFilters();
            });
        }
    });
}

window.onload = () => {
  const email = localStorage.getItem("report_email") || prompt("Nhập email:");
  const token = localStorage.getItem("report_token") || prompt("Nhập token:");

  if (!email || !token) {
    showLoading(false);
    document.getElementById('reportTable').innerHTML = '<div class="alert alert-warning text-center mt-4">Yêu cầu xác thực không thành công. Vui lòng tải lại trang và cung cấp đầy đủ email/token.</div>';
    return;
  }
  
  fetchDataJSONP(email, token);
};


function showColumnSelector() {
    const modal = document.getElementById('column-selector-modal');
    const columnListDiv = document.getElementById('column-list');
    const visibleColumns = table.getColumns().map(c => c.getField());
    
    columnListDiv.innerHTML = '';
    allColumnDefinitions.forEach(colDef => {
        const isVisible = visibleColumns.includes(colDef.field);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="${colDef.field}" id="col-${colDef.field}" ${isVisible ? 'checked' : ''}><label class="form-check-label" for="col-${colDef.field}">${colDef.title}</label></div>`;
        columnListDiv.appendChild(wrapper);
    });
    
    modal.style.display = 'flex';
}

function applyColumnSelection() {
    const selectedFields = Array.from(document.querySelectorAll('#column-list input:checked')).map(cb => cb.value);
    const newColumns = allColumnDefinitions.filter(colDef => selectedFields.includes(colDef.field));
    
    if (newColumns.length > 0) {
        table.setColumns(newColumns);
    } else {
        alert("Bạn phải chọn ít nhất một cột để hiển thị.");
    }
    
    closeColumnSelector();
}

function closeColumnSelector() {
    document.getElementById('column-selector-modal').style.display = 'none';
}

document.getElementById('btn-toggle-cols').addEventListener('click', () => {
    if (table) showColumnSelector();
    else alert("Vui lòng đợi dữ liệu tải xong.");
});

document.getElementById('btn-export').addEventListener('click', () => {
    if (table) table.download("xlsx", "bao_cao_ban_hang.xlsx", { sheetName: "BaoCaoBanHang" });
    else alert("Không có dữ liệu để xuất.");
});

document.getElementById('btn-apply-selection').addEventListener('click', applyColumnSelection);
document.getElementById('btn-cancel-selection').addEventListener('click', closeColumnSelector);
document.getElementById('column-selector-modal').addEventListener('click', (e) => {
    if (e.target.id === 'column-selector-modal') closeColumnSelector();
});
</script>
</body>
</html>