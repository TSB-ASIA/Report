<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo Cáo Bán Hàng</title>
  <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #wrapper {
      display: flex;
      height: 100vh;
    }
    #filters {
      width: 14%;
      background: #f8f9fa;
      padding: 1rem;
      overflow-y: auto;
      border-right: 2px solid #3f8384;
    }
    #reportArea {
      width: 86%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #reportTable {
      flex: 1;
      overflow-x: auto;
      overflow-y: auto;
    }
    h4, label {
      color: #3f8384;
    }
    .tabulator .tabulator-header .tabulator-col {
      background-color: #3f8384;
      color: white;
    }
    .tabulator .tabulator-row .tabulator-cell.numeric {
      text-align: right;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div id="filters">
      <h4>Bộ lọc</h4>
      <label>Ngày giao dịch</label>
      <input id="dateRange" class="form-control mb-2" />
    </div>
    <div id="reportArea">
      <div id="reportTable"></div>
    </div>
  </div>

  <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzCVZTSZPBXVZNUsJawd3xoiv4uEPaxqQUhrUN-BjPaQIGV6SW07baNRRXSfSOXxlKuNw/exec';

    const numericCols = [
      "Số lượng", "Doanh thu thuần", "Đơn giá", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", 
      "Giá bán net", "Giá bán tiêu chuẩn", "Lãi gộp tính lương B2B", "LK tiêu chuẩn", 
      "Điều chỉnh lương khoán KD", "Lương khoán tối thiểu", "Lương khoán/kg", 
      "LK Đức HM", "Lương khoán sales"
    ];

    const percentageCols = [
      "% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"
    ];

    const subtotalCols = [
      "Số lượng", "Doanh thu thuần", "COGS", "Lãi gộp", 
      "Chi phí giao hàng", "Lãi vay", "Lãi gộp tính lương B2B", 
      "LK Đức HM", "Lương khoán sales"
    ];

    function fetchData(email, token) {
      const url = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}`;
      fetch(url)
        .then(response => response.json())
        .then(data => renderData(data))
        .catch(error => {
          console.error("Lỗi khi lấy dữ liệu:", error);
          document.getElementById("reportTable").innerText = "Lỗi tải dữ liệu.";
        });
    }

    function renderData(data) {
      if (!data || data.length === 0) {
        document.getElementById("reportTable").innerText = "Không có dữ liệu phù hợp.";
        return;
      }

      const columns = Object.keys(data[0]).map(key => {
        let columnDef = {
          title: key,
          field: key,
          headerFilter: false,
          resizable: true,
          width: key.length * 14 + 50,
          hozAlign: "left"
        };

        if (numericCols.includes(key)) {
          columnDef.cssClass = 'numeric';
          columnDef.hozAlign = 'right';
          columnDef.formatter = "money";
          columnDef.formatterParams = {
            decimal: "",
            thousand: ",",
            precision: 0
          };
          if (subtotalCols.includes(key)) {
            columnDef.bottomCalc = "sum";
            columnDef.bottomCalcFormatter = "money";
            columnDef.bottomCalcFormatterParams = {
              decimal: "",
              thousand: ",",
              precision: 0
            };
          }
        }

        if (percentageCols.includes(key)) {
          columnDef.cssClass = 'numeric';
          columnDef.hozAlign = 'right';
          columnDef.formatter = cell => {
            let val = Number(cell.getValue());
            return isNaN(val) ? "" : (val * 100).toFixed(2) + "%";
          };
        }

        return columnDef;
      });

      new Tabulator("#reportTable", {
        data: data,
        columns: columns,
        layout: "fitDataTable",
        height: "100%",
        responsiveLayout: false,
        movableColumns: true,
        virtualDom: true,
        resizableRows: false
      });
    }

    window.onload = function() {
      const email = prompt("Nhập email:");
      const token = prompt("Nhập mật khẩu/token:");
      fetchData(email, token);

      new Litepicker({
        element: document.getElementById("dateRange"),
        singleMode: false,
        format: "DD/MM/YYYY",
      });
    }
  </script>
</body>
</html>
