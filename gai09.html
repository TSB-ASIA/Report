<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo Cáo Bán Hàng</title>
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css" rel="stylesheet" />
  <style>
    /* ... CSS giữ nguyên như trước ... */
    body { font-family: Arial, sans-serif; margin: 0; }
    #wrapper { display: flex; height: 100vh; }
    #filters { width: 18%; padding: 1rem; background: #f8f9fa; overflow-y: auto; border-right: 2px solid #3f8384; flex-shrink: 0; }
    #reportArea { width: 82%; display: flex; flex-direction: column; overflow: hidden; }
    #reportTable { flex: 1; overflow: auto; }
    h5,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; display: none; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
    .modal-body { overflow-y: auto; margin-bottom: 15px; }
    .modal-footer { text-align: right; border-top:4, label { color: #3f8384; font-weight: bold; }
    .tabulator .tabulator-header .tabulator-col { background: #3f8384; color: white; text-align: center; }
    .tabulator .tabulator-header .tabulator-col.tabulator-col-movable { cursor: move; }
    .tabulator .tabulator-row .tabulator-cell.numeric { text-align: right; }
    .filter-group { margin-bottom: 12px; }
    .checkbox-group { border: 1px solid #ccc; max-height: 120px; overflow-y: auto; background: #fff; padding: 5px; }
    #loading { position: fixed; top: 0; left: 0; 1px solid #ccc; padding-top: 15px; }
    #column-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
    .select-controls { font-size: 0.8em; font-weight: normal; margin-left: 8px; }
    .select-controls a { text-decoration: none; color: #0d6efd; }
    .select-controls a:hover { text-decoration: underline; }
  </style>
</head>
<body>
<div id="loading">Đang tải dữ liệu...</div>
<div id="column-selector-modal" class="modal-overlay"> <!-- ... Modal HTML ... --> </div>
<div id="wrapper">
  <div id="filters right: 0; bottom: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; display: none; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: "> <!-- ... Filters HTML ... --> </div>
  <div id="reportArea">
    <h2 class="text-center text-primary mt-2">CHI TIẾT HIỆU QUẢ BÁN HÀNG</h2>
    <div class="d-flex justify-content-end px-3 mb-2">
      <!-- ✅ BỔ SUNG: Thêm nút Lưu và Reset cấu hình -->
      <button id="btn-save80vh; display: flex; flex-direction: column; }
    .modal-header { padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
    .modal-body { overflow-y: auto; margin-bottom: 15-config" class="btn btn-info btn-sm me-2">Lưu Cấu hình Cột</button>
      <button id="btn-reset-config" class="btn btn-warning btn-sm me-2">Cấu hình Mặc định</button>
      <button id="btn-toggle-cols" class="btn btnpx; }
    .modal-footer { text-align: right; border-top: 1px solid #ccc; padding-top: 15px; }
    #column-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
    .select-controls { font-size: 0.8em; font-weight:-outline-primary btn-sm me-2">Chọn/Bỏ chọn Cột</button>
      <button id="btn-export" class="btn btn-success btn-sm">Xuất Excel</button>
    </div>
    <div id="reportTable"></div>
  </div>
</div>

<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min. normal; margin-left: 8px; }
    .select-controls a { text-decoration: none; color: #0d6efd; }
    .select-controls a:hover { text-decoration: underline; }
  </style>
</head>
<body>
<div id="loading">Đang tải dữ liệu...</div>
<div id="column-selector-modal" class="modal-overlay"> <!-- ... Modal HTMLjs"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ... --> </div>
<div id="wrapper">
  <div id="filters"> <!-- ... Filters HTML ... --> </div>
  <div id="reportArea">
    <h2 class="text-center text-primary mt-2">CHI TIẾT HIỆU QUẢ BÁN HÀNG</h2>
    <div class=" --- Các hằng số và biến toàn cục giữ nguyên ---
const API_URL = 'https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxd-flex justify-content-end align-items-center px-3 mb-2">
      <!-- ✅ BvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rỔ SUNG: Các nút Lưu và Reset cấu hình -->
      <button id="btn-save-layout" class="btnQxWIbh49/exec';
const COLUMN_CONFIG_KEY = 'report_column_config'; btn-info btn-sm me-2">Lưu Cấu hình</button>
      <button id=" // Key để lưu trong localStorage
let table, originalData = [];
let allColumnDefinitions = [];
let currentEmailbtn-reset-layout" class="btn btn-warning btn-sm me-2">Reset Cấu hình</button>
      <button id="btn-toggle-cols" class="btn btn-outline-primary btn- = "", currentToken = "";
const numericCols = ["Số lượng", "Doanh thu thuần", "Đơn giá", "sm me-2">Chọn/Bỏ chọn Cột</button>
      <button id="btn-exportCOGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Giá bán net", "Giá" class="btn btn-success btn-sm">Xuất Excel</button>
    </div>
    <div id="reportTable"></div>
  </div>
</div>

<script src="https://unpkg.com/tabulator bán tiêu chuẩn", "Lãi gộp tính lương B2B", "LK tiêu chuẩn", "Điều chỉnh lương-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18. khoán KD", "Lương khoán tối thiểu", "Lương khoán/kg", "LK Đức HM", "Lương khoán sales"];
const percentCols = ["% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"];
const subtotalCols = ["Số lượng5/xlsx.full.min.js"></script>
<script>
// --- Các hằng số và biến toàn cục giữ nguyên ---
const API_URL = 'https://script.google.com/macros/s/AKfycbzyp38Q_CMRhhOFnZJep73kMxvRwbFpzZhwSqFcGrxSn0ulAyv35hqc370rQxWI", "Doanh thu thuần", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Lãi gộp tính lương B2B", "LK Đức HM", "Lương khoán sales"];
const FILTER_CONFIG = [ { field: 'Salesman', containerId: 'salesman-filter-container' }, { field: 'Nhóm sản Phẩm', containerId: 'nhom-san-pham-filter-container' }, { field: 'Loại xuất', containerId: 'loai-xuat-filterbh49/exec';
const COLUMN_CONFIG_KEY = 'salesReportColumnConfig'; // Key để lưu trong localStorage
let table, originalData = [];
let allColumnDefinitions = [];
let currentEmail = "", currentToken = "";
const numericCols = ["Số lượng", "Doanh thu thuần", "Đơn giá", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", "Giá bán net", "Giá bán tiêu chuẩn", "Lãi gộp tính lương B2B", "LK tiêu chuẩn", "Điều chỉnh lương khoán KD",-container' }, { field: 'Sản phẩm', containerId: 'product-filter-container' }, { field: 'Vùng miền', containerId: 'region-filter-container' }, { field: 'Quý', containerId: 'quarter-filter-container' }, { field: 'Năm', containerId: 'year-filter-container' } ];


/**
 * ✅ CẬP NHẬT: Logic khởi tạo bảng được nâng "Lương khoán tối thiểu", "Lương khoán/kg", "LK Đức HM", "Lương khoán sales"];
const percentCols = ["% Lãi gộp tiêu chuẩn", "% Điều chỉnh trên giá", "% Điều chỉnh dưới giá", "% lương Khoán"];
const subtotalCols = ["Số lượng", "Doanh thu thuần", "COGS", "Lãi gộp", "Chi phí giao hàng", "Lãi vay", cấp để đọc cấu hình đã lưu.
 */
function myCallback(data) {
  showLoading(false);
  if (!Array.isArray(data) || (Array.isArray(data) && data.length > 0 && typeof data[0] !== 'object')) {
    alert("Sai email hoặc token. Vui lòng nhập lại.");
    localStorage.removeItem("report_email");
    localStorage.removeItem("report_token"); "Lãi gộp tính lương B2B", "LK Đức HM", "Lương khoán sales"];
const FILTER_CONFIG = [ { field: 'Salesman', containerId: 'salesman-filter-container' }, { field: 'Nhóm sản Phẩm', containerId: 'nhom-san-pham-filter-container' }, { field: 'Loại xuất', containerId: 'loai-xuat-filter-container' },
    location.reload();
    return;
  }
  localStorage.setItem("report_email", currentEmail);
  localStorage.setItem("report_token", currentToken);
  originalData = data.map(row => {
    if (row["Ngày giao dịch"] && typeof row["Ngày giao dịch"] === 'string' && row["Ngày giao dịch"].includes("T")) {
      const d = new Date(row["Ngày giao dịch"]);
      row["Ngày giao dịch"] = `${String(d.getDate()).padStart(2, ' { field: 'Sản phẩm', containerId: 'product-filter-container' }, { field: 'Vùng miền', containerId: 'region-filter-container' }, { field: 'Quý', containerId: 'quarter-filter-container' }, { field: 'Năm', containerId: 'year-filter-container' }];

function myCallback(data) {
  // ... (Hàm này giữ nguyên đến phần khởi tạo bảng)
0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
    }
    return row;
  });
  if (originalData.length === 0) {
      document.getElementById('reportTable').innerHTML = '<div class="alert alert-info text-center mt-4">Không có dữ liệu nào để hiển thị.</div>';
      return;
  }
    showLoading(false);
  if (!Array.isArray(data) || (Array.isArray(data) && data.length > 0 && typeof data[0] !== 'object')) {
    alert("Sai email hoặc token. Vui lòng nhập lại."); localStorage.removeItem("report_email"); localStorage.removeItem("report_token"); locationbuildFilters(originalData);
  allColumnDefinitions = Object.keys(originalData[0]).map(key => ({
    title: key, field: key, hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left', cssClass: numericCols.includes(key) ? 'numeric' : '',
    formatter: numericCols.includes(key) ? cell => cell.getValue() != null.reload(); return;
  }
  localStorage.setItem("report_email", currentEmail); localStorage.setItem("report_token", currentToken);
  originalData = data.map(row => { if (row["Ngày giao dịch"] && typeof row["Ngày giao dịch"] === 'string' && row["Ngày giao dịch"].includes("T")) { const d = new Date(row["Ngày giao dịch"]); row["Ngày giao dịch"] = `${String(d ? Number(cell.getValue()).toLocaleString('en-US', { maximumFractionDigits: 0 }) : '' :
               percentCols.includes(key) ? cell => cell.getValue() != null ? `${Number(cell.getValue()).toFixed(2)}%` : '' : undefined,
    bottomCalc: key === 'Giá bán net' ? (values, data) => { const tongDT = data.reduce((s, r) => s +.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; } return row; });
  if (originalData.length === 0) { document.getElementById('reportTable').innerHTML = '<div class="alert alert-info text-center mt-4">Không có dữ liệu nào để hiển thị.</div>'; return; }
  buildFilters(original (r['Doanh thu thuần'] || 0), 0); const tongSL = data.reduce((s, r) => s + (r['Số lượng'] || 0), 0); return tongSL ? (tongDT / tongSL).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 0; } : subtotalCols.includes(key) ? "sum" : undefined,Data);
  allColumnDefinitions = Object.keys(originalData[0]).map(key => ({ title: key, field: key, hozAlign: numericCols.includes(key) || percentCols.includes(key) ? 'right' : 'left', cssClass: numericCols.includes(key) ? 'numeric' : '', formatter: numericCols.includes(key) ? cell => cell.getValue() != null ? Number(cell.getValue()).toLocaleString
    bottomCalcFormatter: "money", bottomCalcFormatterParams: { thousand: ",", precision: 0 }
  }));
  
  // Lấy cấu hình đã lưu từ localStorage
  const savedConfigJSON = localStorage.getItem(COLUMN_CONFIG_KEY);
  let initialColumns = allColumnDefinitions;

  if (savedConfigJSON) {
      try {
          const savedFields = JSON.parse(savedConfigJSON);
          //('en-US', { maximumFractionDigits: 0 }) : '' : percentCols.includes(key) ? cell => cell.getValue() != null ? `${Number(cell.getValue()).toFixed(2)}%` : '' : undefined, bottomCalc: key === 'Giá bán net' ? (values, data) => { const tongDT = data.reduce((s, r) => s + (r['Doanh thu thuần'] || 0), 0); Tạo lại danh sách cột theo đúng thứ tự và các cột đã lưu
          initialColumns = savedFields.map(field => {
              // Tìm định nghĩa đầy đủ của cột từ danh sách gốc
              return allColumnDefinitions.find(def => const tongSL = data.reduce((s, r) => s + (r['Số lượng'] || 0), 0); return tongSL ? (tongDT / tongSL).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}) : 0; } : subtotalCols.includes(key) ? def.field === field);
          }).filter(Boolean); // Lọc bỏ những cột có thể không còn tồn tại
      } catch (e) {
          console.error("Lỗi đọc cấu hình cột:", e);
          // Nếu lỗi, quay về mặc định
          initialColumns = allColumnDefinitions;
      }
  }

  table = "sum" : undefined, bottomCalcFormatter: "money", bottomCalcFormatterParams: { thousand: ",", precision: 0 } }));
  
  // ✅ CẬP NHẬT: Tải cấu hình cột khi khởi tạo bảng
  let initial new Tabulator("#reportTable", { 
    data: originalData, 
    columns: initialColumns, // Sử dụng cấu hình đã xử lý
    height: "100%", 
    movableColumns: true, 
    placeholder: "Không có dữ liệu phù hợp với bộ lọc.", 
    rowFormatter: rowColumns = allColumnDefinitions;
  const savedConfigJSON = localStorage.getItem(COLUMN_CONFIG_KEY);
  if (savedConfigJSON) {
      try {
          const savedFields = JSON.parse(savedConfigJSON);
          const defsMap = new Map(allColumnDefinitions.map(def => [def.field, def])); => { if (row.getData()["Salesman"] === "TỔNG CỘNG") { row.getElement().style.backgroundColor = "#e0f0ff"; row.getElement().style.fontWeight = "bold"; } }, 
    columnDefaults
          // Tạo lại cấu hình cột theo thứ tự đã lưu, chỉ lấy các cột còn tồn tại
          const reorderedDefs = savedFields.map(field => defsMap.get(field)).filter(Boolean);
          : { tooltip: true } 
  });
  
  setupLiveFilterEvents();
}


// --- Các hàm khác không thay đổi ---
// (Bao gồm showColumnSelector, applyColumnSelection, applyFilters, ...)
function showLoading(show = true) { document.getElementById("loading").style.display = show ? "flex" : "none"; }
// Ẩn các cột không có trong danh sách đã lưu
          allColumnDefinitions.forEach(def => {
              function showColumnSelector() {
    const modal = document.getElementById('column-selector-modal');
    const columnListDiv = document.getElementById('column-list');
    const currentColumns = table.getColumns(true);
    def.visible = savedFields.includes(def.field);
          });
          initialColumns = allColumnDefinitions;
const visibleColumnFields = table.getColumns().map(c => c.getField());
    columnListDiv.innerHTML = '';
    currentColumns.forEach(column => {
        const field = column.getField();
        const definition      } catch (e) {
          console.error("Lỗi khi tải cấu hình cột:", e);
          localStorage.removeItem(COLUMN_CONFIG_KEY); // Xóa cấu hình lỗi
      }
  }

   = column.getDefinition();
        const isVisible = visibleColumnFields.includes(field);
        const wrapper = document.table = new Tabulator("#reportTable", {
    data: originalData,
    columns: initialColumns, // Sử dụng cấu hình đã tải hoặc mặc định
    height: "100%",
    movableColumns: true, createElement('div');
        wrapper.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="${field}" id="col-${field}" ${isVisible ? 'checked' : ''}><label class="form-check-label" for="col-${field}">${definition.title}</label>
    placeholder: "Không có dữ liệu phù hợp với bộ lọc.",
    rowFormatter: row => { if (row.getData()["Salesman"] === "TỔNG CỘNG") { row.getElement().style.backgroundColor = "#e0f0ff"; row.getElement().style.fontWeight = "bold"; } },
    columnDefaults:</div>`;
        columnListDiv.appendChild(wrapper);
    });
    modal.style.display = 'flex';
}
function applyColumnSelection() {
    const selectedFields = Array.from(document.querySelectorAll { tooltip: true }
  });

  // ✅ CẬP NHẬT: Gắn sự kiện để tự động lưu khi kéo-thả cột
  table.on("columnMoved", function(column, columns){
    ('#column-list input:checked')).map(cb => cb.value);
    table.getColumns().forEach(column => column.hide());
    if (selectedFields.length > 0) {
        selectedFields.forEach((saveColumnLayout(false); // Lưu lại thứ tự mới một cách âm thầm
  });
  
  setupLiveFilterEvents();
}

/**
 * ✅ BỔ SUNG: Hàm lưu cấu hình cột hiện tại vào localStorage
field, index) => {
            const column = table.getColumn(field);
            if (column) {
                column.show();
                column.move(index);
            }
        });
    } else {
        alert("Bạn phải chọn ít nhất một cột để hiển thị.");
    }
    closeColumnSelector * @param {boolean} showAlert - Có hiển thị thông báo cho người dùng hay không
 */
function saveColumnLayout(showAlert = true) {
    if (!table) return;
    
    // Chỉ lấy các cột đang();
}
function closeColumnSelector() { document.getElementById('column-selector-modal').style.display = 'none'; }
function fetchDataJSONP(email, token) {
  showLoading(true);
  currentEmail = email;
  currentToken = token;
  const script = document.createElement('script');
  script.src hiển thị và thứ tự của chúng
    const visibleColumns = table.getColumns().filter(c => c.isVisible());
    const columnFieldsInOrder = visibleColumns.map(c => c.getField());
    
    localStorage.setItem = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`;
  script.onerror = () => { showLoading(false); alert("Lỗi kết nối tới máy chủ dữ liệu. Vui lòng kiểm tra lại đường truyền mạng."); document.getElementById('reportTable').innerHTML =(COLUMN_CONFIG_KEY, JSON.stringify(columnFieldsInOrder));
    
    if (showAlert) {
        alert('Đã lưu cấu hình cột thành công!');
    }
}

/**
 * ✅ '<div class="alert alert-danger text-center mt-4">Không thể tải dữ liệu.</div>'; };
  document.body.appendChild(script);
}
function buildFilters(data) {
  FILTER_ BỔ SUNG: Hàm reset cấu hình cột
 */
function resetColumnLayout() {
    if (confirm('Bạn có chắc muốn xóa cấu hình đã lưu và quay về mặc định?')) {
        localStorage.removeItem(COLUMN_CONFIG_CONFIG.forEach(config => {
    if (data.length > 0 && data[0].hasOwnProperty(KEY);
        alert('Đã xóa cấu hình. Trang sẽ được tải lại.');
        location.reload();config.field)) {
        const container = document.getElementById(config.containerId);
        if (container
    }
}

// ✅ CẬP NHẬT: Hàm applyColumnSelection giờ cũng sẽ lưu cấu hình
function applyColumnSelection() {
    const selectedFields = Array.from(document.querySelectorAll('#column-list input) {
          const uniqueValues = [...new Set(data.map(r => r[config.field]).filter(val => val !== null && val !== undefined))].sort();
          if (uniqueValues.length > 0) {
              container.innerHTML = uniqueValues.map(v => { const label = v === '' ? '(Tr:checked')).map(cb => cb.value);
    
    if (selectedFields.length > 0) {
        // Ẩn tất cả trước
        table.getColumns(true).forEach(column => {
            ifống)' : v; return `<div><label><input type="checkbox" value="${v}" checked /> ${label}</label></div>`; }).join('');
              const labelElement = container.previousElementSibling;
              if (label (!selectedFields.includes(column.getField())) {
                column.hide();
            }
        });
        Element && labelElement.tagName === 'LABEL') {
                // Xóa control cũ nếu có để tránh trùng lặp khi// Hiện lại theo đúng thứ tự
        selectedFields.forEach((field, index) => {
            const column = redraw
                const oldControls = labelElement.querySelector('.select-controls');
                if (oldControls) oldControls.remove();
                const controls = document.createElement('span');
                controls.className = 'select-controls';
                 table.getColumn(field);
            if (column) {
                column.show();
                column.movecontrols.innerHTML = `(<a href="#" class="select-all" data-target="${config.containerId}">(index);
            }
        });

        saveColumnLayout(false); // Lưu lại cấu hình mới một cách âm thầm
    } else {
        alert("Bạn phải chọn ít nhất một cột để hiển thị.");Tất cả</a> | <a href="#" class="deselect-all" data-target="${config.containerId}">B
    }
    
    closeColumnSelector();
}


// --- Dưới đây là các hàm không thay đổi, để đảm bảo tính đầy đủ ---
function showLoading(show = true) { document.getElementById("loading").style.ỏ chọn</a>)`;
                labelElement.appendChild(controls);
              }
          } else {
              container.parentElement.style.display = 'none';
          }
        }
    } else {
        const container = document.getElementById(config.containerId);
        if (container) container.parentElement.style.display = 'nonedisplay = show ? "flex" : "none"; }
function showColumnSelector() {
    const modal = document.getElementById('column-selector-modal');
    const columnListDiv = document.getElementById('column-list';
    }
  });
}
function getCheckedValues(containerId) {
  const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
  return Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
}
function isDateInRange');
    const allTableColumns = table.getColumns(true);
    columnListDiv.innerHTML = '';
    (dateStr, range) {
  if (!dateStr || !range || range.length < 2) return false;
  try {
    const [day, month, year] = dateStr.split('/');
allTableColumns.forEach(column => {
        const field = column.getField();
        const definition = column.getDefinition();
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `<div class="form-check"><input class="form-check-input" type="checkbox" value="${field}" id="    const date = new Date(`${year}-${month}-${day}`);
    const startDate = new Date(range[0].split('/').reverse().join('-'));
    const endDate = new Date(range[1].split('/').reverse().join('-'));col-${field}" ${column.isVisible() ? 'checked' : ''}><label class="form-check-label" for="col-${field}">${definition.title}</label></div>`;
        columnListDiv.appendChild(wrapper);
    });
    modal.style.display = 'flex';
}
function closeColumnSelector() { document.getElementById('
    return date >= startDate && date <= endDate;
  } catch(e) { return false; }
}
function applyFilters() {
  const customerFilterValue = document.getElementById('customerFilter').value.toLowerCase().trim();
  const dateRangeInput = document.getElementById('dateRange');
  const dateRangeValue =column-selector-modal').style.display = 'none'; }
function fetchDataJSONP(email, token) { showLoading(true); currentEmail = email; currentToken = token; const script = document.createElement('script'); script dateRangeInput.value ? dateRangeInput.value.split(' - ') : [];
  const filteredData = originalData.filter(row => {
    const customerMatch = customerFilterValue === '' || String(row['.src = `${API_URL}?email=${encodeURIComponent(email)}&token=${encodeURIComponent(token)}&callback=myCallback`; script.onerror = () => { showLoading(false); alert("Lỗi kết nối tới máy chủKhách hàng'] || '').toLowerCase().includes(customerFilterValue);
    const dateMatch = !dateRangeInput.value || isDateInRange(row['Ngày giao dịch'], dateRangeValue);
    if (!customerMatch || dữ liệu. Vui lòng kiểm tra lại đường truyền mạng."); document.getElementById('reportTable').innerHTML = '<div class="alert alert-danger text-center mt-4">Không thể tải dữ liệu.</div>'; }; document.body.appendChild !dateMatch) return false;
    for (const config of FILTER_CONFIG) {
      const allCheckboxes = document.querySelectorAll(`#${config.containerId} input[type="checkbox"]`);
      if (all(script); }
function buildFilters(data) { FILTER_CONFIG.forEach(config => { if (data.length > 0 && data[0].hasOwnProperty(config.field)) { const container = document.getElementById(Checkboxes.length > 0) {
        const checkedValues = getCheckedValues(config.containerId);
        if (checkedValues.length === 0) return false;
        const rowValue = String(row[config.field] || '');
        if (!checkedValues.includes(rowValue)) { return false; }config.containerId); if (container) { const uniqueValues = [...new Set(data.map(r => r[config.field]).filter(val => val !== null && val !== undefined))].sort(); if (uniqueValues.length
      }
    }
    return true;
  });
  if (table) { table.setData(filteredData); }
}
function setupLiveFilterEvents() {
    const filtersDiv = document.getElementById > 0) { container.innerHTML = uniqueValues.map(v => { const label = v === '' ? '(Trống)' : v; return `<div><label><input type="checkbox" value="${v}" checked /> ${('filters');
    filtersDiv.addEventListener('click', (e) => {
        const target = e.label}</label></div>`; }).join(''); const labelElement = container.previousElementSibling; if (labelElement && labelElement.tagName === 'LABEL') { const controls = document.createElement('span'); controls.className = 'select-controls';target;
        if (target.tagName === 'A' && (target.classList.contains('select-all controls.innerHTML = `(<a href="#" class="select-all" data-target="${config.containerId}">Tất cả</a> | <a href="#" class="deselect-all" data-target="${config.containerId}">B') || target.classList.contains('deselect-all'))) {
            e.preventDefault();
            const targetContainerId = target.dataset.target;
            const checkStatus = target.classList.contains('select-all');ỏ chọn</a>)`; labelElement.appendChild(controls); } } else { container.parentElement.style.display = 'none'; } } } else { const container = document.getElementById(config.containerId); if (container) container.
            if (targetContainerId) {
                const checkboxes = document.querySelectorAll(`#${targetContainerId} input[type="checkbox"]`);
                checkboxes.forEach(cb => { cb.checked = checkStatus; });
                applyFilters();
            }
        }
    });
    filtersDiv.querySelectorAll('input[type="text"]').parentElement.style.display = 'none'; } }); }
function getCheckedValues(containerId) { const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]`); return Array.from(checkboxes).filter(cbforEach(el => { el.addEventListener('input', applyFilters); });
    filtersDiv.querySelectorAll('.checkbox-group').forEach(el => { el.addEventListener('change', applyFilters); });
    new Litepicker({ element: document.getElementById('dateRange'), singleMode: false, format: "DD/MM/YYYY", autoApply: => cb.checked).map(cb => cb.value); }
function isDateInRange(dateStr, range) { if (!dateStr || !range || range.length < 2) return false; try { const [day, month, year] = dateStr.split('/'); const date = new Date(`${year}-${month}-${day}`); false,
        setup: (picker) => { picker.on('selected', () => applyFilters()); picker.on('clear:selection', () => applyFilters()); }
    });
}
window.onload = () => {
  const email = localStorage.getItem("report_email") || prompt("Nhập email:");
  const const startDate = new Date(range[0].split('/').reverse().join('-')); const endDate = new Date(range[1].split('/').reverse().join('-')); return date >= startDate && date <= endDate; } catch(e) token = localStorage.getItem("report_token") || prompt("Nhập token:");
  if (!email || !token) {
    showLoading(false);
    document.getElementById('reportTable').innerHTML = '<div class="alert alert-warning text-center mt-4">Yêu cầu xác thực không thành công. Vui lòng { return false; } }
function applyFilters() { const customerFilterValue = document.getElementById('customerFilter').value.toLowerCase().trim(); const dateRangeInput = document.getElementById('dateRange'); const dateRangeValue = dateRangeInput.value ? dateRangeInput.value.split(' - ') : []; const filteredData = originalData. tải lại trang và cung cấp đầy đủ email/token.</div>';
    return;
  }
  fetchDataJSONP(email, token);
};

// --- Gắn sự kiện cho các nút điều khiển ---
document.getElementById('btn-toggle-cols').addEventListener('click', () => { if (table) showColumnSelectorfilter(row => { const customerMatch = customerFilterValue === '' || String(row['Khách hàng'] || '').toLowerCase().includes(customerFilterValue); const dateMatch = !dateRangeInput.value || isDateInRange(row['Ngày giao dịch'], dateRangeValue); if (!customerMatch || !dateMatch) return false; for (const config of(); else alert("Vui lòng đợi dữ liệu tải xong."); });
document.getElementById('btn-export').addEventListener('click', () => { if (table) table.download("xlsx", "bao_cao_ban_hang FILTER_CONFIG) { const allCheckboxes = document.querySelectorAll(`#${config.containerId} input[type="checkbox"]`); if (allCheckboxes.length > 0) { const checkedValues = getCheckedValues(config.containerId.xlsx", { sheetName: "BaoCaoBanHang" }); else alert("Không có dữ liệu để xuất."); });
document.getElementById('btn-apply-selection').addEventListener('click', applyColumnSelection);
document.getElementById('btn); if (checkedValues.length === 0) return false; const rowValue = String(row[config.field] || ''); if (!checkedValues.includes(rowValue)) { return false; } } } return true; }); if (table) { table.setData(filteredData); } }
function setupLiveFilterEvents() { const filtersDiv-cancel-selection').addEventListener('click', closeColumnSelector);
document.getElementById('column-selector-modal').addEventListener('click', (e) => { if (e.target.id === 'column-selector-modal') = document.getElementById('filters'); filtersDiv.addEventListener('click', (e) => { const target = e.target; if (target.tagName === 'A' && (target.classList.contains('select-all') || closeColumnSelector(); });

/**
 * ✅ BỔ SUNG: Gắn sự kiện cho các nút Lưu và Reset cấu hình.
 */
document.getElementById('btn-save-config').addEventListener('click', () => {
    if target.classList.contains('deselect-all'))) { e.preventDefault(); const targetContainerId = target.dataset.target; const checkStatus = target.classList.contains('select-all'); if (targetContainerId) { const checkboxes = document.querySelectorAll(`#${targetContainerId} input[type="checkbox"]`); checkboxes.forEach(cb => (!table) {
        alert("Vui lòng đợi dữ liệu tải xong.");
        return;
    } { cb.checked = checkStatus; }); applyFilters(); } } }); filtersDiv.querySelectorAll('input[type="text"]').forEach(el => { el.addEventListener('input', applyFilters); }); filtersDiv.querySelectorAll('.checkbox-group').forEach(el => { el.addEventListener('change', applyFilters); }); new Litepicker({ element: document.getElementById('dateRange'),
    // Lấy danh sách các cột đang hiển thị theo đúng thứ tự hiện tại
    const currentVisibleColumns = table.getColumns().map(c => c.getField());
    // Lưu vào localStorage
    localStorage.setItem(COLUMN_CONFIG_KEY, JSON.stringify(currentVisibleColumns));
    alert("Cấu hình cột đã được lưu thành công!");
});

document.getElementById('btn-reset-config').addEventListener('click', () => {
     singleMode: false, format: "DD/MM/YYYY", autoApply: false, setup: (picker) => { picker.on('selected', () => applyFilters()); picker.on('clear:selection', () => applyFilters()); } }); }
window.onload = () => { const email = localStorage.getItem("report_email")if (!table) {
        alert("Vui lòng đợi dữ liệu tải xong.");
        return;
    }
    // Xóa cấu hình đã lưu
    localStorage.removeItem(COLUMN_CONFIG_KEY);
     || prompt("Nhập email:"); const token = localStorage.getItem("report_token") || prompt("Nhập token:"); if (!email || !token) { showLoading(false); document.getElementById('reportTable').innerHTML = '<div class="alert alert-warning text-center mt-4">Yêu cầu xác thực không thành công. V// Áp dụng lại cấu hình mặc định cho bảng
    table.setColumns(allColumnDefinitions);
    alert("Cấu hình cột đã được trả về mặc định.");
});

</script>
</body>
</html>